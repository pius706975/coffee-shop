# Node Express Modular Architecture
A boilerplate/starter project for quickly building RESTful APIs using Node.js, Express, and sequelize.

It incorporates the latest technologies, such as `npm` for package management and `eslint` for enforcing coding guidelines and best practices.

By running a single command, you will get a production-ready Node.js app installed and fully configured on your machine. The app comes with many built-in features, such as authentication using JWT, and request validation.

## Manual Installation
If you would still prefer to do the installation manually, follow these steps:

Clone the repo

Install the dependencies:
```bash
npm install
```

Set the environment variables:

```bash
# open .env and modify the environment variables (if needed)
```

## Features

- **Postgresql**: [Sequelize](https://sequelize.org/) 
- **Authentication and authorization**: using [jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken)
- **Validation**: request data validation using [Joi](https://github.com/hapijs/joi)
- **Logging**: using [winston](https://github.com/winstonjs/winston) 
- **Dependency management**: with [npm](https://www.npmjs.com/)
- **Environment variables**: using [dotenv](https://github.com/motdotla/dotenv) and [node-config](https://www.npmjs.com/package/config)
- **CORS**: Cross-Origin Resource-Sharing enabled using [cors](https://github.com/expressjs/cors)

## Commands
Running locally:

```bash
npm start 
```

Linting:

```bash
# run ESLint
npm run lint

# fix ESLint errors
npm run lint:fix
```

## Environment Variables
The environment variables can be found and modified in the `.env` file. They come with these default values:

```bash
# Port number
PORT=3002

# Set environment
NODE_ENV=development

# node-config directory path
NODE_CONFIG_DIR=./src/config
```

## Project Structure

```
src/
|--config/                  # Environment variables and configuration-related files.
|--components/              # Contains individual components.
   |--component.module.js   # Entry file for the component.
   |--component.controller.js   # Controller for the component.
   |--component.service.js      # Service for the component.
   |--component.routes.js       # Routes for the component.
   |--component.validator.js    # Validators for the component.
|--docs/                    # Swagger files for API documentation.
|--middlewares/             # Custom Express middlewares.
|--db/                      # Sequelize ORM files for the data layer.
   |--models/               # Sequelize models.
   |--seeders/              # Sequelize seeders.
   |--migrations/           # Sequelize migrations.
|--utils/                   # Utility classes and functions.
|--loaders/                 # Lodash routes and configurations; also validates configurations.
|--support/                 # Wrapper for used packages, enabling easy package replacement.
|--app.js                   # Express app setup.
|--index.js                # Entry point for the application.
```

## Validation

Request data is validated using [Joi](https://joi.dev/). Check the [documentation](https://joi.dev/api/) for more details on how to write Joi validation schemas.

The validation schemas are defined in the `src/components/{eachComponent}/validations` directory and are used in the routes by providing them as parameters to the `validate` middleware.

```javascript
router.post(
  '/login',  
  makeValidatorCallback(AuthValidator.validateLogin), 
  makeExpressCallback(AuthController.login)
  );
```
## Authentication
To require authentication for certain routes, you can use the `auth` middleware.

```javascript
// Routes
const AuthRoutes =  require('../components/Auth/auth.routes');
module.exports  =  function  getRoutes(app) {
app.use('/api/v1/auth', AuthRoutes);
};
```

The routes require a valid JWT access token in the Authorization request header using the Bearer schema. If the request does not contain a valid access token, an Unauthorized (401) error is thrown.

**Generating Access Tokens**:

An access token can be generated by making a successful call to the register (`POST /v1/auth/register`) or login (`POST /v1/auth/login`) endpoints. The response of these endpoints also contains refresh tokens (explained below).

An access token is valid for one day. You can modify this expiration time by changing the  config variable in the `config/default.yaml` file.
```
JWT_SIGN_OPTIONS:
  issuer:  My Compny Pvt Ltd
  audience:  https://example.in
  expiresIn:  1d
```

**Refreshing Access Tokens**:

After the access token expires, a new access token can be generated, by making a call to the refresh token endpoint (`POST /v1/auth/refresh-tokens`) and sending along a valid refresh token in the request body. This call returns a new access token and a new refresh token.

An access token is valid for one day. You can modify this expiration time by changing the  config variable in the `config/development.yaml` file.

## Authorization

The `auth` middleware can also be used to require certain rights/permissions to access a route.

```javascript
const express = require('express');
const auth = require('../../middlewares/auth');
const userController = require('../../controllers/user.controller');

const router = express.Router();

router.post('/users', auth('manageUsers'), userController.createUser);
```

In the example above, an authenticated user can access this route only if that user has the `manageUsers` permission.

The permissions are role-based. You can view the permissions/rights of each role in the `src/config/roles.js` file.

If the user making the request does not have the required permissions to access this route, a Forbidden (403) error is thrown.

## Logging

Import the logger from `src/config/logger.js`. It is using the [Winston](https://github.com/winstonjs/winston) logging library.

Logging should be done according to the following severity levels (ascending order from most important to least important):

```javascript
const logger = require('<path to src>/config/logger');

logger.error('message'); // level 0
logger.warn('message'); // level 1
logger.info('message'); // level 2
logger.http('message'); // level 3
logger.verbose('message'); // level 4
logger.debug('message'); // level 5
```

In development mode, log messages of all severity levels will be printed to the console.

In production mode, only `info`, `warn`, and `error` logs will be printed to the console.\
It is up to the server (or process manager) to actually read them from the console and store them in log files.\
This app uses pm2 in production mode, which is already configured to store the logs in log files.

## Linting

Linting is done using [ESLint](https://eslint.org/) and [Prettier](https://prettier.io).

In this app, ESLint is configured to follow the [Airbnb JavaScript style guide](https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb-base) with some modifications. It also extends [eslint-config-prettier](https://github.com/prettier/eslint-config-prettier) to turn off all rules that are unnecessary or might conflict with Prettier.

To modify the ESLint configuration, update the `.eslintrc.json` file. To modify the Prettier configuration, update the `.prettierrc.json` file.